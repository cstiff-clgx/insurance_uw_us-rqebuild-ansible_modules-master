- name: "Clear temp dir"
  win_file:
    state: absent
    path: "{{ temp_dir }}"

- name: "Create temp dir"
  win_file:
    state: directory
    path: "{{ temp_dir }}"

- name: Copy template to deploy dir
  win_template:
    src: deploy.ps1.j2
    dest: "{{ temp_dir }}\\ansible_deploy.ps1"

- name: Run deploy script from PD
  win_shell: "{{ temp_dir }}\\ansible_deploy.ps1"
  register: script_output
  become: yes
  become_user: rqe
  become_method: runas
  become_flags: logon_type=interactive logon_flags=with_profile

- name: Print installation script output
  debug:
    msg: "{{ script_output.stdout.split('\r') }}"

- name: Print installation script ERRORS output
  debug:
    msg: "{{ script_output.stderr.split('\r') }}"

- name: Delete autogenerated deploy script
  win_file:
    path: "{{ temp_dir }}\\ansible_deploy.ps1"
    state: absent

- name: Reboot a machine that takes time to settle after being booted
  win_reboot:
    post_reboot_delay: 120
