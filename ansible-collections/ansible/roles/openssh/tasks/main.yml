---
- name: Updating PS security protocol
  win_shell: |
    [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
  become_method: runas

- name: "Get info for OpenSSH Server"
  win_service:
    name: sshd
  register: service_info

- name: "Remove OpenSSH Server if exists"
  win_service:
    name: sshd
    state: absent
  when: service_info.exists|bool == True

- name: "Download OpenSSH Server"
  win_get_url:
    url: "{{ openssh_server_package }}"
    dest: "{{ temp_dir }}\\{{ openssh_server_name }}"

- name: "UnZip OpenSSH Server"
  win_command: '"C:\\Program Files\\7-Zip\\7z.exe" x {{ temp_dir }}\{{ openssh_server_name }} -oC:\ -y'

- name: "Install OpenSSH Server"
  win_shell: 'C:\OpenSSH-Win64\install-sshd.ps1 >> C:\OpenSSH-Win64\install_log.txt'
  args:
    chdir: 'C:\OpenSSH-Win64\'

- name: Copy ssh config
  win_copy:
    src: 'c:\OpenSSH-Win64\sshd_config_default'
    dest: 'c:\OpenSSH-Win64\sshd_config'
    remote_src: yes

- name: "Install OpenSSH Server"
  win_shell: 'C:\OpenSSH-Win64\FixHostFilePermissions.ps1 -confirm:$false >> C:\OpenSSH-Win64\install_log.txt'
  args:
    chdir: 'C:\OpenSSH-Win64\'

- name: "Start OpenSSH Server service"
  win_service:
    name: sshd
    state: restarted
    start_mode: auto
